<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:widget="http://www.netvibes.com/ns/">
<head>
	<meta charset="UTF-8" />
    <title>Antenna specs</title>

    <meta name="author" content="CCT3" />
    <meta name="description" content="Huawei antenna specifications per site - acquire and display data from a CSV file" />
    <meta name="debugMode" content="true" />
    <meta name="strictMode" content="false" />

    <!-- Widget preferences -->
    <widget:preferences>
        <widget:preference type="text" name="urlCSV" label="CSV file URL" defaultValue='https://vdemopro393dsy.extranet.3ds.com/3DSpace/webapps/Huawei/csv/HuaweiLExistingAntennas.csv' />
				<widget:preference type="hidden" name="allData" label="Table data" defaultValue='' />
        <widget:preference type="text" name="selectedCong" label="Selected configuration" defaultValue='MyConf' />
    </widget:preferences>

    <script type="text/javascript" src="scripts/jquery-3.1.1.min.js"></script>

    <script>
        window.onerror = function(e){}
    </script>
    <script>
        //Any widget code here
        require([
          "UWA/Drivers/jQuery",
          "UWA/Utils/InterCom",// In 15x for communication between widgets
          "DS/WAFData/WAFData"
        ], function(
          $,
          InterCom,// In 15x for communication between widgets
          WAFData
        ){
          var myWidget = {
            allText: "",
            allTextLines: [],
            headers: [],
            i: 0,

            /*
            * Function that generates an HTML table from previous data stored in the widget's preference as a JSON string
						* First get the data from the widget's preference then uses these data to create the table using the generateTable() function
            */
						cleanTable: function() {
							$(".table1").show();
							$(".table2").show();
							$(".table3").show();
							$(".sector1").show();
							$(".sector2").show();
							$(".sector3").show();
							myWidget.generateTableFromArrays();
						},

						showAll: function() {
							$(".table1").show();
							$(".table2").show();
							$(".table3").show();
							$(".sector1").show();
							$(".sector2").show();
							$(".sector3").show();
						},

						searchFilter: function(searchQuery) {
							/** Check if data already stored in the widget's preference. If that's the case, generate table using stored data. **/
              if(widget.getValue("allData") != "") {
								switch (searchQuery) {
									case "G900":
									case "U900":
									case "G900/U900":
										myWidget.showAll();
										$(".table2").hide();
										$(".table3").hide();
										break;
									case "U2100":
										myWidget.showAll();
										$(".table1").hide();
										$(".table3").hide();
										break;
									case "Existing LTE FDD":
										myWidget.showAll();
										$(".table1").hide();
										$(".table2").hide();
										break;
									case "Sector 1":
										myWidget.showAll();
										$(".sector2").hide();
										$(".sector3").hide();
										break;
									case "Sector 2":
										myWidget.showAll();
										$(".sector1").hide();
										$(".sector3").hide();
										break;
									case "Sector 3":
										myWidget.showAll();
										$(".sector1").hide();
										$(".sector2").hide();
										break;
									default:
										console.log("THE SEARCH QUERY DIDN'T MATCH ANY EXISTING ELEMENT!");
								}
							}
						},

            generateTableFromArrays: function() {
              $('table').empty();
              allText = JSON.parse(widget.getValue("allData"));
              myWidget.generateTable(allText);
            },

            /*
            * Function that generates an HTML table from
            */
            generateTable: function(allText) {
							var tableNumber = 1;
              allTextLines = allText.split(/\r\n|\n/);  // split the file content string by line (return to line...)
              var numberOfLines = allTextLines.length-1; // number of lines = total number of lines - header line (1)
              headers = allTextLines[0].split(';'); // split the first line by element (separated with ';')
              var numberOfColumns = headers.length; // number of columns = number of elements in the first row
              var numberOfElements = allTextLines.length;
              var regexEmptyRow = /(;){2,}/i; // regex used to determine whether csv row is empty (just ';', no values in between)

              // Table title row
              var $titleRow = $('<tr/>');
              $('<td/>').appendTo($titleRow);
              $('<td/>').text(headers[0]).attr('colspan', numberOfColumns-1).addClass("tableTitle table" + tableNumber).appendTo($titleRow);
              $('table').append($titleRow);

              // Table columns title row
              var $row = $('<tr/>').addClass("table" + tableNumber);
              $('<th/>').appendTo($row);
              for(var i=1 ; i<numberOfColumns ; i++) {
                $('<th/>').text(headers[i]).addClass("titleBlue sector" + i).appendTo($row);  // put column name in the element, add id for style (background color) and append to the header row
              }
              $('table').append($row);

              for (var i=1; i<numberOfElements ; i++) {
                // If empty row in the CSV, put blank row, then set new table title and column titles
                if(regexEmptyRow.test(allTextLines[i].trim())) {
                  // Table space (blank/empty) row used to separate each subtable of the table (different antenna type)
                  var $row = $('<tr/>').addClass("spaceRow table" + tableNumber);
                  $('table').append($row);
									tableNumber++;
                  i++;

                  // Table title row
                  var titleLine = allTextLines[i].split(';');
                  var tableTitle = titleLine[0];
                  var $titleRow = $('<tr/>').addClass("table" + tableNumber);
                  $('<td/>').appendTo($titleRow);
                  $('<td/>').text(tableTitle).attr('colspan', numberOfColumns-1).addClass("tableTitle").appendTo($titleRow);
                  $('table').append($titleRow);

                  // Table columns title row
                  var $colTitleRow = $('<tr/>').addClass("table" + tableNumber);
                  $('<td/>').appendTo($colTitleRow);
                  for(var colTitle=1 ; colTitle<numberOfColumns ; colTitle++) {
                    $('<td/>').text(titleLine[colTitle]).addClass("titleBlue sector" + colTitle).appendTo($colTitleRow);  // put column name in the element, add id for style (background color) and append to the header row
                  }
                  $('table').append($colTitleRow);
                }
                //If normal row ('data row'), simple layout with parameter name first then parameter values
                else {
                  var textData = allTextLines[i].split(';');
                  if (textData.length == headers.length) {
                    var $row = $('<tr/>').addClass("table" + tableNumber);
                    for(var j=0 ; j<numberOfColumns ; j++) {
                      //Parameter name/row title
                      if(j==0) {
                        $('<td/>').text(textData[j].trim()).addClass("titleBlue parameter").appendTo($row);
                      }
                      //Parameter value
                      else {
                        $('<td/>').text(textData[j].trim()).addClass("bodyGrey sector" + j).appendTo($row);
                      }
                      $('table').append($row);
                    }
                  }
                }
              }
              //$('#backgroundPicture').hide();
              $('#projectSummaryTable').show();
            },

            onLoadWidget: function() {
              widget.log("--------------ON LOAD WIDGET---------------");
							var wdgUrl = widget.getUrl();
							widget.log("WIDGET URL IS : " + wdgUrl);
							wdgUrl=wdgUrl.substring(0, wdgUrl.lastIndexOf("/"));
							//$("#backgroundPicture").attr("src","/3DSpace/webapps/Huawei/images/huawei_antenna_background.JPG");
              $('#projectSummaryTable').hide();

							/** INTERCOM library for communications between widgets in 15x **/
							myWidget.sockets = {};
							myWidget.sockets.listen = new InterCom.Socket('InterCom.Listen' + widget.id);
							myWidget.sockets.listen.subscribeServer('uwa.embedded');

							myWidget.sockets.listen.addListener('GlobeViewer.Camera.move', function(json) {
								widget.log("GLOBE VIEWER CLICKED MARKER DATA : " + json.text);
								if(json.text=="14.47294787,121.034529,3") {
									widget.log("LOAD DATA FROM CSV ASSOCIATED TO THIS GEOGRAPHICAL MARKER");
									/*
									$.get("https://vdemopro393dsy.extranet.3ds.com/3DSpace/webapps/Huawei/csv/HuaweiLExistingAntennas.csv", function(data) {
										myWidget.generateTable(data);
										widget.setValue("allData", JSON.stringify(data));
									});
									*/
								}
							});

							//Register to be able to send messages in 15x
							myWidget.sockets.dispatch = new InterCom.Socket('InterCom.Dispatch' + widget.id);
							myWidget.sockets.dispatch.subscribeServer('uwa.embedded');
							//15x - InterCom END

              /** Check if data already stored in the widget's preference. If that's the case, generate table using stored data. **/
              if(widget.getValue("allData") != "") {
                myWidget.generateTableFromArrays();
              }
							else {
								// DIRECTLY LOAD DATA FROM THE CSV, NOT WAITING FOR EVENT
								var antennaFileUrl = widget.getValue("urlCSV");
								$.get(antennaFileUrl, function(data) {
									myWidget.generateTable(data);
									widget.setValue("allData", JSON.stringify(data));
								});
							}
            },

            onRefreshWidget: function() {
							widget.log("--------------ON REFRESH WIDGET---------------");
              /** Start managing file picker **/
              $('#projectSummaryTable').hide();

							/** INTERCOM library for communications between widgets in 15x **/
							myWidget.sockets = {};
							myWidget.sockets.listen = new InterCom.Socket('InterCom.Listen' + widget.id);
							myWidget.sockets.listen.subscribeServer('uwa.embedded');

							myWidget.sockets.listen.addListener('GlobeViewer.Camera.move', function(json) {
								widget.log("GLOBE VIEWER CLICKED MARKER DATA : " + json.text);
								if(json.text=="14.47294787,121.034529,3") {
									widget.log("LOAD DATA FROM CSV ASSOCIATED TO THIS GEOGRAPHICAL MARKER");
									/*
									$.get("https://vdemopro393dsy.extranet.3ds.com/3DSpace/webapps/Huawei/csv/HuaweiLExistingAntennas.csv", function(data) {
										myWidget.generateTable(data);
										widget.setValue("allData", JSON.stringify(data));
									});
									*/
								}
							});

							//Register to be able to send messages in 15x
							myWidget.sockets.dispatch = new InterCom.Socket('InterCom.Dispatch' + widget.id);
							myWidget.sockets.dispatch.subscribeServer('uwa.embedded');
							//15x - InterCom END

              /** Check if data already stored in the browser localStorage. If that's the case, generate table using stored data. **/
              if(widget.getValue("allData") != "") {
                myWidget.generateTableFromArrays();
              }
            },
						/** 3DSearch for refining widget's content**/
		        onSearchWidget: function(searchQuery) {
		          console.log("???????????????????????????????????? ONSEARCHWIDGET : " + searchQuery);
							myWidget.searchFilter(searchQuery);
		    		},

		    		onResetSearchWidget: function() {
		          console.log("???????????????????????????????????? ONRESETSEARCHWIDGET : " + searchQuery);
		    			//Remove search from filters
		    			myWidget.cleanTable();
		    		}
          };
					widget.myWidget=myWidget;
          widget.addEvent("onLoad", myWidget.onLoadWidget);
          widget.addEvent("onRefresh", myWidget.onRefreshWidget);
					widget.addEvent("onSearch", myWidget.onSearchWidget);
					widget.addEvent("onResetSearch", myWidget.onResetSearchWidget);
          widget.log("ADD EVENT COMPLETED OOKOKOKOKOKOKOKOKOKOKOKO!");
        });

    </script>

    <style>
				html, body {
					height: 100%;
				  margin: 0;
				  padding: 0;
				}

				#antennaSpecs {
					overflow: auto;
					height: 100%;
				}

				#backgroundPicture {
					padding: 0;
				  display: block;
				  margin: 0 auto;
				  max-height: 100%;
				  max-width: 100%;
				}

        table, td, th {
          border: 4px solid white;
          font-family: "Calibri", Calibri, sans-serif;
          font-size: 18px;
					overflow: auto;
        }

        th {
          text-align: center;
          color: #FEFEFE;
          padding: 15px;
        }

        td {
          text-align: center;
          padding: 20px;
        }

        table {
          border-collapse: collapse;
          width: 100%;
          margin-bottom: 20px;
        }

        .tableTitle {
          color: #00497C;
          font-weight: bold;
          font-size: 1.1em;
        }

        .spaceRow {
          height: 30px !important; /* overwrites any other rules */
          background-color: #FFFFFF;
        }

        .titleBlue {
          background-color: #00497C;
          color: #FEFEFE;
          font-weight: bold;
          font-size: 1.1em;
        }

        .bodyGrey {
          background-color: #D0D9EA;
        }

        .parameter {
          color: #FEFEFE;
        }
    </style>

</head>

<body>
	<div id="antennaSpecs">
    <!-- <img id="backgroundPicture" src="" alt="Huawei antenna background"> -->

    <table id="projectSummaryTable">
        <tr></tr>
    </table>
	</div>
</body>

</html>
